<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reservas | Tu Marca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Incluir jsPDF desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #000000;
      color: #fff;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 420px;
      margin: auto;
      padding: 30px 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #f1c40f;
    }

    p {
      text-align: center;
      color: #ccc;
      margin-bottom: 30px;
    }

    .btn {
      width: 100%;
      padding: 16px;
      margin: 10px 0;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: #1f1f1f;
      color: #fff;
    }

    .btn:hover {
      background: #333;
    }

    .btn-primary {
      background: #e74c3c;
      font-weight: bold;
    }

    .btn-primary:hover {
      background: #c0392b;
    }

    .btn-secondary {
      background: #34495e;
    }

    .btn-secondary:hover {
      background: #2c3e50;
    }

    .btn-success {
      background: #27ae60;
      font-weight: bold;
    }

    .btn-success:hover {
      background: #229954;
    }

    .hidden {
      display: none;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #666;
      margin-top: 40px;
    }

    /* Estilos del formulario */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #ccc;
    }

    input, select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #1f1f1f;
      color: #fff;
      box-sizing: border-box;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #e74c3c;
    }

    .reminder {
      background: #2c2c2c;
      border-left: 4px solid #e74c3c;
      padding: 15px;
      margin: 20px 0;
      border-radius: 0 8px 8px 0;
      font-size: 14px;
    }

    .reminder h3 {
      margin-top: 0;
      color: #e74c3c;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #333;
      margin: 0 5px;
    }

    .step.active {
      background: #e74c3c;
    }

    .summary {
      background: #1f1f1f;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-label {
      color: #aaa;
    }

    .summary-value {
      font-weight: bold;
    }

    .local-info {
      font-size: 14px;
      color: #999;
      margin-top: 5px;
      text-align: center;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: #e74c3c;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .pdf-preview {
      background: #1f1f1f;
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      border: 1px solid #333;
    }

    .pdf-preview h3 {
      color: #e74c3c;
      margin-top: 0;
      text-align: center;
    }

    .pdf-info {
      font-size: 14px;
      color: #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- Paso 1 - Tipo de reserva -->
  <div id="step1">
    <div class="step-indicator">
      <div class="step active"></div>
      <div class="step"></div>
      <div class="step"></div>
    </div>
    
    <h1>Reservas</h1>
    <p>¬øQu√© deseas reservar?</p>

    <button class="btn btn-primary" onclick="selectTipo('Restaurante')">üçΩ Haz Tu Reserva</button>
  </div>

  <!-- Paso 2 - Selecci√≥n de local -->
  <div id="step2" class="hidden">
    <div class="step-indicator">
      <div class="step"></div>
      <div class="step active"></div>
      <div class="step"></div>
    </div>
    
    <h1>Selecciona tu local</h1>
    <p>Elige uno de nuestros locales disponibles</p>

    <div class="form-group">
      <label for="local-select">Local:</label>
      <select id="local-select" onchange="updateLocalInfo()">
        <option value="">Selecciona un local...</option>
        <!-- Locales ordenados alfab√©ticamente A-Z -->
        <option value="Alajuela Centro">Alajuela Centro</option>
        <option value="Bar Heredia">Bar Heredia</option>
        <option value="Bar San Joaquin">Bar San Joaquin</option>
        <option value="Barrio San Jose">Barrio San Jose</option>
        <option value="Pirro">Pirro</option>
        <option value="Sabana">Sabana</option>
        <option value="San Joaquin">San Joaquin</option>
        <option value="San Pedro">San Pedro</option>
        <option value="Universidad Nacional">Universidad Nacional</option>
      </select>
    </div>

    <button class="btn btn-secondary" onclick="backToStep1()">‚¨Ö Volver</button>
    <button class="btn btn-primary" onclick="proceedToForm()" id="continue-btn" disabled>Continuar</button>
  </div>

  <!-- Paso 3 - Formulario de reserva -->
  <div id="step3" class="hidden">
    <div class="step-indicator">
      <div class="step"></div>
      <div class="step"></div>
      <div class="step active"></div>
    </div>
    
    <h1>Completa tu reserva</h1>
    <p>Local: <span id="local-selected"></span></p>

    <form id="reservation-form">
      <div class="form-group">
        <label for="local">Local:</label>
        <input type="text" id="local" readonly>
      </div>

      <div class="form-group">
        <label for="date">Fecha:</label>
        <input type="date" id="date" required>
      </div>

      <div class="form-group">
        <label for="time">Hora:</label>
        <input type="time" id="time" required>
      </div>

      <div class="form-group">
        <label for="people">N√∫mero de personas:</label>
        <select id="people" required>
          <option value="">Selecciona...</option>
          <option value="1">1 persona</option>
          <option value="2">2 personas</option>
          <option value="3">3 personas</option>
          <option value="4">4 personas</option>
          <option value="5">5 personas</option>
          <option value="6">6 personas</option>
          <option value="7">7 personas</option>
          <option value="8">8 personas</option>
          <option value="9">9 personas</option>
          <option value="10">10 personas</option>
          <option value="11">M√°s de 10 personas</option>
        </select>
      </div>

      <div class="form-group">
        <label for="name">Nombre completo:</label>
        <input type="text" id="name" required>
      </div>

      <div class="form-group">
        <label for="phone">N√∫mero de tel√©fono:</label>
        <input type="tel" id="phone" required>
      </div>

      <div class="reminder">
        <h3>‚ö†Ô∏è Importante</h3>
        <p>Recordar que despu√©s de la hora acordada cuenta con 5 minutos de gracia, de no estar se proceder√° a eliminar la reserva.</p>
      </div>

      <button type="button" class="btn btn-secondary" onclick="backToStep2()">‚¨Ö Volver</button>
      <button type="submit" class="btn btn-primary">Generar PDF</button>
    </form>
  </div>

  <!-- Paso 4 - Vista previa del PDF -->
  <div id="step4" class="hidden">
    <div class="step-indicator">
      <div class="step"></div>
      <div class="step"></div>
      <div class="step"></div>
    </div>
    
    <h1>PDF Generado</h1>
    <p>Revisa tu reserva antes de enviar</p>

    <div class="summary" id="reservation-summary">
      <!-- Los detalles se llenar√°n con JavaScript -->
    </div>

    <div class="pdf-preview">
      <h3>üìÑ Vista Previa del PDF</h3>
      <div id="pdf-preview-content">
        <!-- Vista previa del PDF se generar√° aqu√≠ -->
      </div>
      <div class="pdf-info">
        <p><strong>Nombre del archivo:</strong> <span id="pdf-filename"></span></p>
        <p>El PDF se generar√° con el formato: <code>Nombre_Tel√©fono.pdf</code> para f√°cil b√∫squeda en WhatsApp.</p>
      </div>
    </div>

    <div class="reminder">
      <h3>‚ö†Ô∏è Recordatorio</h3>
      <p>Despu√©s de la hora acordada cuenta con 5 minutos de gracia, de no estar se proceder√° a eliminar la reserva.</p>
    </div>

    <button class="btn btn-secondary" onclick="backToStep3()">‚¨Ö Editar reserva</button>
    <button class="btn btn-success" onclick="sendPDFToWhatsApp()">üì§ Enviar PDF por WhatsApp</button>
  </div>

  <!-- Paso 5 - Carga y confirmaci√≥n -->
  <div id="step5" class="hidden">
    <div class="loading">
      <div class="spinner"></div>
      <h3>Generando PDF...</h3>
      <p>Tu archivo se est√° preparando para enviar.</p>
    </div>
  </div>

  <footer>
    ¬© La Parrillita de Pepe ¬∑ Reservas oficiales ¬∑ WhatsApp: 50661781454
  </footer>

</div>

<script>
  // Variables globales para almacenar los datos de la reserva
  let tipoSeleccionado = '';
  let localSeleccionado = '';
  const numeroWhatsApp = '50661781454';
  let reservationData = {};
  let pdfBlob = null;
  let pdfFileName = '';

  // Paso 1: Seleccionar tipo de reserva
  function selectTipo(tipo) {
    tipoSeleccionado = tipo;
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
  }

  // Actualizar informaci√≥n del local seleccionado
  function updateLocalInfo() {
    const select = document.getElementById('local-select');
    const continueBtn = document.getElementById('continue-btn');
    
    if (select.value) {
      continueBtn.disabled = false;
    } else {
      continueBtn.disabled = true;
    }
  }

  // üîí Fechas bloqueadas por local
  const fechasBloqueadas = {
    "Alajuela Centro": [],
    "Bar Heredia": [],
    "Bar San Joaquin": [],
    "Barrio San Jose": [],
    "Pirro": [],
    "Sabana": [],
    "San Joaquin": [],
    "San Pedro": ["2026-02-14"],
    "Universidad Nacional": []
  };

  // üö´ Validar fechas bloqueadas seg√∫n el local
  document.getElementById('date').addEventListener('change', function () {
    const fechaSeleccionada = this.value;
    const local = localSeleccionado;

    if (!local) return;

    if (fechasBloqueadas[local]?.includes(fechaSeleccionada)) {
      alert("‚ùå Esta fecha no est√° disponible para este local. Por favor elige otra.");
      this.value = "";
    }
  });

  // Proceder al formulario despu√©s de seleccionar local
  function proceedToForm() {
    const select = document.getElementById('local-select');
    
    if (!select.value) {
      alert('Por favor, selecciona un local.');
      return;
    }
    
    localSeleccionado = select.value;
    
    // Actualizar el texto en el paso 3
    document.getElementById('local-selected').textContent = localSeleccionado;
    document.getElementById('local').value = localSeleccionado;
    
    // Mostrar paso 3
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
    
    // Configurar fecha m√≠nima como hoy
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').setAttribute('min', today);
    
    // Configurar hora m√≠nima y m√°xima
    document.getElementById('time').setAttribute('min', '10:00');
    document.getElementById('time').setAttribute('max', '22:00');
  }

  // Paso 3: Volver al paso 2
  function backToStep2() {
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
  }

  // Paso 2: Volver al paso 1
  function backToStep1() {
    // Resetear la selecci√≥n del local
    document.getElementById('local-select').value = '';
    document.getElementById('continue-btn').disabled = true;
    
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
  }

  // Paso 4: Volver al paso 3
  function backToStep3() {
    document.getElementById('step4').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
  }

  // Manejar el env√≠o del formulario
  document.getElementById('reservation-form').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // Obtener los datos del formulario
    reservationData = {
      tipo: tipoSeleccionado,
      local: localSeleccionado,
      fecha: document.getElementById('date').value,
      hora: document.getElementById('time').value,
      personas: document.getElementById('people').value,
      nombre: document.getElementById('name').value,
      telefono: document.getElementById('phone').value,
      fechaCreacion: new Date().toLocaleString('es-ES')
    };
    
    // Validar que todos los campos est√©n completos
    for (let key in reservationData) {
      if (!reservationData[key] && key !== 'fechaCreacion') {
        alert('Por favor, completa todos los campos del formulario.');
        return;
      }
    }
    
    // Mostrar paso de carga
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step5').classList.remove('hidden');
    
    // Generar PDF despu√©s de un peque√±o delay para mostrar la animaci√≥n
    setTimeout(() => {
      generatePDF();
    }, 500);
  });

  // Generar PDF con los datos de la reserva
  function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configurar nombre del archivo
    const nombreSinEspacios = reservationData.nombre.replace(/\s+/g, '_');
    const telefonoLimpio = reservationData.telefono.replace(/\s+/g, '');
    pdfFileName = `${nombreSinEspacios}_${telefonoLimpio}.pdf`;
    
    // Configurar el documento
    doc.setFontSize(20);
    doc.setTextColor(44, 62, 80);
    doc.text('CONFIRMACI√ìN DE RESERVA', 105, 20, { align: 'center' });
    
    // Logo/Encabezado
    doc.setFontSize(12);
    doc.setTextColor(52, 73, 94);
    doc.text('La Parrillita de Pepe', 105, 30, { align: 'center' });
    
    // L√≠nea separadora
    doc.setDrawColor(231, 76, 60);
    doc.setLineWidth(0.5);
    doc.line(20, 35, 190, 35);
    
    // Informaci√≥n de la reserva
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    
    let y = 45;
    
    // Formatear fecha para mostrar
    const fecha = new Date(reservationData.fecha);
    const fechaFormateada = fecha.toLocaleDateString('es-ES', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    // Tabla de informaci√≥n
    const tableData = [
      ['Tipo de Reserva', reservationData.tipo],
      ['Local', reservationData.local],
      ['Fecha', fechaFormateada],
      ['Hora', reservationData.hora],
      ['N√∫mero de Personas', reservationData.personas],
      ['Nombre', reservationData.nombre],
      ['Tel√©fono', reservationData.telefono],
      ['Fecha de Creaci√≥n', reservationData.fechaCreacion],
      ['N√∫mero de Referencia', generarNumeroReferencia()]
    ];
    
    // Usar autoTable para una tabla m√°s profesional
    doc.autoTable({
      startY: 50,
      head: [['Detalle', 'Informaci√≥n']],
      body: tableData,
      theme: 'grid',
      headStyles: { fillColor: [231, 76, 60], textColor: [255, 255, 255] },
      styles: { fontSize: 10, cellPadding: 5 },
      columnStyles: { 
        0: { fontStyle: 'bold', cellWidth: 70 },
        1: { cellWidth: 100 }
      },
      margin: { left: 20, right: 20 }
    });
    
    // Obtener la posici√≥n Y despu√©s de la tabla
    const finalY = doc.lastAutoTable.finalY + 15;
    
    // Recordatorio importante
    doc.setFontSize(10);
    doc.setTextColor(231, 76, 60);
    doc.setFont(undefined, 'bold');
    doc.text('‚ö†Ô∏è RECORDATORIO IMPORTANTE', 20, finalY);
    
    doc.setFontSize(9);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    const reminderText = 'Despu√©s de la hora acordada cuenta con 5 minutos de gracia, de no estar se proceder√° a eliminar la reserva.';
    doc.text(reminderText, 20, finalY + 8, { maxWidth: 170 });
    
    // Informaci√≥n de contacto
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text('Para consultas o modificaciones contactar al WhatsApp: 50661781454', 105, 280, { align: 'center' });
    // Guardar PDF como blob
    pdfBlob = doc.output('blob');
    
    // Mostrar resumen en el paso 4
    showReservationSummary();
    
    // Mostrar vista previa del PDF
    showPDFPreview();
    
    // Mostrar nombre del archivo
    document.getElementById('pdf-filename').textContent = pdfFileName;
    
    // Ir al paso 4
    document.getElementById('step5').classList.add('hidden');
    document.getElementById('step4').classList.remove('hidden');
  }

  // Generar n√∫mero de referencia √∫nico
  function generarNumeroReferencia() {
    const fecha = new Date();
    const timestamp = fecha.getTime().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `RES-${timestamp}${random}`;
  }

  // Mostrar vista previa del PDF
  function showPDFPreview() {
    const previewDiv = document.getElementById('pdf-preview-content');
    
    // Crear una vista previa simple del PDF
    previewDiv.innerHTML = `
      <div style="background: white; color: black; padding: 15px; border-radius: 5px; font-family: Arial, sans-serif;">
        <h4 style="color: #2c3e50; margin-top: 0; text-align: center;">CONFIRMACI√ìN DE RESERVA</h4>
        <p style="color: #e74c3c; text-align: center; font-weight: bold;">La Parrillita de Pepe</p>
        <hr style="border-color: #e74c3c;">
        
        <div style="margin-top: 15px;">
          <p><strong>Tipo de Reserva:</strong> ${reservationData.tipo}</p>
          <p><strong>Local:</strong> ${reservationData.local}</p>
          <p><strong>Fecha:</strong> ${reservationData.fecha}</p>
          <p><strong>Hora:</strong> ${reservationData.hora}</p>
          <p><strong>Personas:</strong> ${reservationData.personas}</p>
          <p><strong>Nombre:</strong> ${reservationData.nombre}</p>
          <p><strong>Tel√©fono:</strong> ${reservationData.telefono}</p>
        </div>
        
        <div style="background: #ffeaa7; padding: 10px; border-left: 3px solid #e74c3c; margin-top: 15px;">
          <p style="margin: 0; font-size: 12px;">
            <strong>‚ö†Ô∏è Recordatorio:</strong> Despu√©s de la hora acordada cuenta con 5 minutos de gracia, de no estar se proceder√° a eliminar la reserva.
          </p>
        </div>
        
        <p style="font-size: 10px; color: #666; text-align: center; margin-top: 15px;">
          Para consultas: WhatsApp 50661781454
        </p>
      </div>
    `;
  }

  // Mostrar resumen de la reserva
  function showReservationSummary() {
    const summaryDiv = document.getElementById('reservation-summary');
    
    // Formatear fecha para mostrar
    const fecha = new Date(reservationData.fecha);
    const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const fechaFormateada = fecha.toLocaleDateString('es-ES', opcionesFecha);
    
    // Crear el HTML del resumen
    summaryDiv.innerHTML = `
      <div class="summary-item">
        <span class="summary-label">Local:</span>
        <span class="summary-value">${reservationData.local}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Fecha:</span>
        <span class="summary-value">${fechaFormateada}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Hora:</span>
        <span class="summary-value">${reservationData.hora}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Personas:</span>
        <span class="summary-value">${reservationData.personas}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Nombre:</span>
        <span class="summary-value">${reservationData.nombre}</span>
      </div>
    `;
  }

  // Enviar PDF por WhatsApp
  function sendPDFToWhatsApp() {
    if (!pdfBlob) {
      alert('Error: No se ha generado el PDF. Por favor, intenta nuevamente.');
      return;
    }
    
    // Crear un mensaje inicial para WhatsApp
    const mensajeInicial = `Hola üëç\n\n*Resumen:*\n‚Ä¢ Local: ${reservationData.local}\n‚Ä¢ Fecha: ${reservationData.fecha}\n‚Ä¢ Hora: ${reservationData.hora}\n‚Ä¢ Personas: ${reservationData.personas}\n‚Ä¢ Nombre: ${reservationData.nombre}\n\nPor favor, confirma mi reserva.`;
    
    // Enviar primero el mensaje de texto
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensajeInicial)}`;
    
    // Abrir WhatsApp en una nueva ventana
    const whatsappWindow = window.open(urlWhatsApp, '_blank');
    
    // Nota: No podemos adjuntar el PDF autom√°ticamente por seguridad del navegador
    // El usuario tendr√° que adjuntar manualmente el PDF descargado
    // Primero descargamos el PDF para que el usuario lo tenga
    downloadPDF();
    
    // Mostrar instrucciones
    setTimeout(() => {
      if (whatsappWindow && !whatsappWindow.closed) {
        alert('PDF generado con √©xito. Por favor:\n1. El PDF se ha descargado a tu dispositivo\n2. En WhatsApp, adjunta el PDF manualmente\n3. Env√≠a el archivo para completar tu reserva\n\nNombre del archivo: ' + pdfFileName);
      }
    }, 1000);
  }

  // Descargar el PDF
  function downloadPDF() {
    const url = URL.createObjectURL(pdfBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = pdfFileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Configurar fecha m√≠nima al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    if (document.getElementById('date')) {
      document.getElementById('date').setAttribute('min', today);
    }
  });
</script>

</body>
</html>